<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - Versant 2026</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ó≠Ô∏è</text></svg>">
</head>
<body>
  <!-- Navigation -->
  <nav class="nav-sticky">
    <div class="nav-container">
      <a href="index.html" class="nav-brand">
        <span class="brand-icon">‚ó≠</span>
        <span class="brand-text">Versant ‚Ä¢ Admin</span>
      </a>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Retour au site</a>
        <a href="#" class="nav-link" id="logoutBtn" style="color: #ef4444;">D√©connexion</a>
      </div>
    </div>
  </nav>

  <!-- Login Section -->
  <section class="ranking-section" id="loginSection" style="padding-top: 120px;">
    <div style="max-width: 400px; margin: 0 auto; padding: 0 24px;">
      <div class="info-box" style="padding: 40px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">üîê</div>
        <h2 style="font-family: 'Syne', sans-serif; font-size: 24px; margin-bottom: 24px;">
          Acc√®s Administration
        </h2>
        
        <div id="loginError" style="display: none; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
        
        <form id="adminLoginForm">
          <input 
            type="password" 
            id="adminPassword" 
            placeholder="Mot de passe admin"
            required
            style="width: 100%; padding: 14px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 16px; margin-bottom: 16px; box-sizing: border-box;"
          >
          <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f97316, #f43f5e); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
            Connexion
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Admin Dashboard -->
  <section class="ranking-section" id="adminDashboard" style="display: none; padding-top: 120px;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      
      <div class="section-header" style="margin-bottom: 40px;">
        <span class="section-number">üîß</span>
        <h2 class="section-title">Panneau d'Administration</h2>
        <p class="section-desc">G√©rer la ligue Versant 2026</p>
      </div>

      <!-- Stats rapides -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div class="info-box" style="text-align: center; padding: 24px;">
          <div style="font-size: 36px; font-weight: 700; color: #f97316;" id="statAthletes">-</div>
          <div style="color: rgba(255,255,255,0.6); font-size: 14px;">Athl√®tes inscrits</div>
        </div>
        <div class="info-box" style="text-align: center; padding: 24px;">
          <div style="font-size: 36px; font-weight: 700; color: #22d3ee;" id="statActivities">-</div>
          <div style="color: rgba(255,255,255,0.6); font-size: 14px;">Activit√©s</div>
        </div>
        <div class="info-box" style="text-align: center; padding: 24px;">
          <div style="font-size: 36px; font-weight: 700; color: #10b981;" id="statExcluded">0</div>
          <div style="color: rgba(255,255,255,0.6); font-size: 14px;">Activit√©s exclues</div>
        </div>
      </div>

      <!-- Actions -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
        
        <!-- Webhook Strava -->
        <div class="info-box">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            ü™ù Webhook Strava (temps r√©el)
          </h3>
          <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px;">
            Recevez automatiquement les nouvelles activit√©s d√®s qu'un athl√®te les enregistre sur Strava.
          </p>
          <div id="webhookStatus" style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 16px; font-size: 14px;">
            Statut: <span style="color: #fbbf24;">Cliquez sur Activer pour v√©rifier</span>
          </div>
          <div style="display: flex; gap: 12px;">
            <button id="enableWebhookBtn" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ‚úÖ Activer
            </button>
            <button id="disableWebhookBtn" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              üóëÔ∏è D√©sactiver
            </button>
          </div>
        </div>

        <!-- Synchronisation -->
        <div class="info-box">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            üîÑ Synchronisation Strava
          </h3>
          <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px;">
            Synchroniser manuellement les activit√©s de tous les athl√®tes.
          </p>
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <input type="date" id="syncStartDate" style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
            <input type="date" id="syncEndDate" style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
          </div>
          <button id="syncBtn" style="width: 100%; padding: 12px; background: #22d3ee; color: #0a0a0f; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Lancer la synchronisation
          </button>
          <div id="syncResult" style="margin-top: 12px; font-size: 14px;"></div>
        </div>

        <!-- Export Classement -->
        <div class="info-box">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            üèÜ Export Classement
          </h3>
          <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px;">
            G√©n√©rer et t√©l√©charger le classement actuel en JSON.
          </p>
          <button id="exportRankingBtn" style="width: 100%; padding: 12px; background: #a855f7; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">
            üì• T√©l√©charger le classement (JSON)
          </button>
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 13px;">
            <div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">‚è∞ Export automatique quotidien</div>
            <div style="color: #10b981;">Tous les jours √† 20h ‚Üí GitHub</div>
          </div>
        </div>

        <!-- T√©l√©chargements -->
        <div class="info-box">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            üì• T√©l√©charger les donn√©es
          </h3>
          <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px;">
            Exporter les fichiers JSON bruts.
          </p>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="download-btn" data-file="athletes" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; text-align: left;">
              üìã athletes.json
            </button>
            <button class="download-btn" data-file="activities" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; text-align: left;">
              üèÉ activities.json
            </button>
            <button class="download-btn" data-file="jokers" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; text-align: left;">
              üÉè jokers_usage.json
            </button>
          </div>
        </div>

        <!-- Gestion des activit√©s (exclure) -->
        <div class="info-box" style="grid-column: 1 / -1;">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            üèÉ Gestion des activit√©s
          </h3>
          <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px;">
            Exclure ou r√©int√©grer des activit√©s qui ne respectent pas les r√®gles du challenge.
          </p>
          
          <!-- Filtres -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input type="text" id="activitySearch" placeholder="Rechercher (nom, athl√®te...)" style="flex: 1; min-width: 200px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
            <select id="activityFilter" style="padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
              <option value="all">Toutes les activit√©s</option>
              <option value="active">Actives uniquement</option>
              <option value="excluded">Exclues uniquement</option>
            </select>
            <button id="refreshActivitiesBtn" style="padding: 10px 20px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
              üîÑ Rafra√Æchir
            </button>
          </div>
          
          <div id="activitiesList" style="max-height: 500px; overflow-y: auto;">
            <p style="color: rgba(255,255,255,0.5);">Chargement...</p>
          </div>
        </div>

        <!-- Liste des athl√®tes -->
        <div class="info-box" style="grid-column: 1 / -1;">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            üë• Athl√®tes inscrits
          </h3>
          <div id="athletesList" style="max-height: 400px; overflow-y: auto;">
            <p style="color: rgba(255,255,255,0.5);">Chargement...</p>
          </div>
        </div>

        <!-- Logs -->
        <div class="info-box" style="grid-column: 1 / -1;">
          <h3 style="color: #f97316; margin-bottom: 16px; font-family: 'Syne', sans-serif;">
            üìú Journal des actions
          </h3>
          <div id="logsContainer" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 16px; font-family: 'Space Mono', monospace; font-size: 13px; max-height: 200px; overflow-y: auto;">
            <div style="color: rgba(255,255,255,0.5);">En attente d'actions...</div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer" style="margin-top: 80px;">
    <div class="footer-content">
      <div class="footer-brand">‚ó≠ Versant</div>
      <p class="footer-text">Panneau d'administration</p>
    </div>
  </footer>

  <script>
    const API_BASE = '/api';
    const LEAGUE_ID = 'versant-2026';
    let adminPassword = null;
    let allActivities = [];
    let athletesCache = {}; // Cache pour r√©soudre les noms d'athl√®tes

    // ============================================
    // AUTHENTIFICATION
    // ============================================
    function checkAuth() {
      adminPassword = localStorage.getItem('versant_admin_password');
      if (adminPassword) {
        showDashboard();
      } else {
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('adminDashboard').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      loadDashboardData();
      checkWebhookStatus(); // V√©rifier le statut du webhook
    }

    // Fonction pour v√©rifier le statut du webhook
    async function checkWebhookStatus() {
      const status = document.getElementById('webhookStatus');
      status.innerHTML = `Statut: <span style="color: #fbbf24;">‚è≥ V√©rification...</span>`;
      
      try {
        const response = await fetch(`${API_BASE}/admin/strava/subscribe/status`, {
          headers: { 'X-Admin-Password': adminPassword }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          if (data.active) {
            status.innerHTML = `Statut: <span style="color: #10b981;">‚úÖ Actif</span> (ID: ${data.subscription?.id || 'N/A'})`;
            addLog(`üì° Webhook Strava actif (ID: ${data.subscription?.id})`);
          } else {
            status.innerHTML = `Statut: <span style="color: #ef4444;">‚ùå Inactif</span> - Cliquez sur Activer`;
          }
        } else {
          status.innerHTML = `Statut: <span style="color: #fbbf24;">‚ö†Ô∏è Erreur v√©rification</span>`;
        }
      } catch (error) {
        status.innerHTML = `Statut: <span style="color: #ef4444;">‚ùå Erreur r√©seau</span>`;
      }
    }

    document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;
      
      try {
        const response = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        if (!response.ok) {
          throw new Error('Mot de passe incorrect');
        }

        adminPassword = password;
        localStorage.setItem('versant_admin_password', password);
        showDashboard();
        addLog('‚úÖ Connexion admin r√©ussie');

      } catch (error) {
        document.getElementById('loginError').textContent = error.message;
        document.getElementById('loginError').style.display = 'block';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('versant_admin_password');
      adminPassword = null;
      showLogin();
    });

    // ============================================
    // CHARGEMENT DES DONN√âES
    // ============================================
    async function loadDashboardData() {
      try {
        // Charger les athl√®tes
        const athletesRes = await fetch(`${API_BASE}/athletes/${LEAGUE_ID}`);
        const athletes = await athletesRes.json();
        
        // Cr√©er le cache des athl√®tes (id -> objet complet)
        athletesCache = {};
        athletes.forEach(a => {
          athletesCache[a.id] = a;
        });
        
        // Charger les activit√©s
        const activitiesRes = await fetch(`${API_BASE}/activities/${LEAGUE_ID}`);
        allActivities = await activitiesRes.json();

        // Compter les exclues
        const excludedCount = allActivities.filter(a => a.excluded).length;

        // Mettre √† jour les stats
        document.getElementById('statAthletes').textContent = athletes.length;
        document.getElementById('statActivities').textContent = allActivities.length;
        document.getElementById('statExcluded').textContent = excludedCount;

        // Afficher les listes
        renderAthletesList(athletes);
        renderActivitiesList();
        
        // Charger les donn√©es des jokers
        loadJokersData();

        // D√©finir les dates par d√©faut pour la sync
        const today = new Date();
        const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('syncEndDate').value = today.toISOString().split('T')[0];
        document.getElementById('syncStartDate').value = weekAgo.toISOString().split('T')[0];

        addLog(`üìä Donn√©es charg√©es: ${athletes.length} athl√®tes, ${allActivities.length} activit√©s (${excludedCount} exclues)`);

      } catch (error) {
        console.error('Erreur chargement:', error);
        addLog(`‚ùå Erreur: ${error.message}`);
      }
    }

    // Fonction pour obtenir le nom d'un athl√®te (pour les activit√©s)
    function getAthleteName(activity) {
      // Priorit√©: athlete_name dans l'activit√©, sinon chercher dans le cache
      if (activity.athlete_name) return activity.athlete_name;
      if (activity.athlete_id && athletesCache[activity.athlete_id]) {
        const a = athletesCache[activity.athlete_id];
        return a.name || `${a.firstname || ''} ${a.lastname || ''}`.trim() || `#${activity.athlete_id}`;
      }
      return 'Inconnu';
    }
    
    // Fonction pour obtenir le nom court d'un athl√®te par ID (pour les jokers)
    function getAthleteShortName(id) {
      if (athletesCache[id]) {
        const a = athletesCache[id];
        if (a.firstname && a.lastname) {
          return `${a.firstname} ${a.lastname.charAt(0)}.`;
        }
        return a.name || `#${id}`;
      }
      return `#${id}`;
    }

    function renderAthletesList(athletes) {
      const container = document.getElementById('athletesList');
      
      if (athletes.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.5);">Aucun athl√®te inscrit</p>';
        return;
      }

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Nom</th>
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Email</th>
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">ID Strava</th>
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Inscrit le</th>
            </tr>
          </thead>
          <tbody>
            ${athletes.map(a => `
              <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                <td style="padding: 12px 8px; font-weight: 500;">${a.name}</td>
                <td style="padding: 12px 8px; color: rgba(255,255,255,0.7);">${a.email || '-'}</td>
                <td style="padding: 12px 8px; font-family: 'Space Mono', monospace; font-size: 13px;">${a.id}</td>
                <td style="padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">${new Date(a.registered_at).toLocaleDateString('fr-FR')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============================================
    // GESTION DES ACTIVIT√âS
    // ============================================
    function renderActivitiesList() {
      const container = document.getElementById('activitiesList');
      const search = document.getElementById('activitySearch').value.toLowerCase();
      const filter = document.getElementById('activityFilter').value;

      let filtered = allActivities;

      // Filtrer par recherche
      if (search) {
        filtered = filtered.filter(a => 
          a.name?.toLowerCase().includes(search) ||
          a.athlete_name?.toLowerCase().includes(search)
        );
      }

      // Filtrer par statut
      if (filter === 'active') {
        filtered = filtered.filter(a => !a.excluded);
      } else if (filter === 'excluded') {
        filtered = filtered.filter(a => a.excluded);
      }

      // Trier par date (plus r√©cent en premier)
      filtered.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

      if (filtered.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.5);">Aucune activit√© trouv√©e</p>';
        return;
      }

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Date</th>
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Athl√®te</th>
              <th style="text-align: left; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Activit√©</th>
              <th style="text-align: right; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Distance</th>
              <th style="text-align: right; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">D+</th>
              <th style="text-align: center; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Statut</th>
              <th style="text-align: center; padding: 12px 8px; color: rgba(255,255,255,0.6); font-size: 13px;">Action</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.slice(0, 100).map(a => `
              <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); ${a.excluded ? 'opacity: 0.5;' : ''}">
                <td style="padding: 12px 8px; font-size: 13px;">${new Date(a.start_date).toLocaleDateString('fr-FR')}</td>
                <td style="padding: 12px 8px; font-weight: 500;">${getAthleteName(a)}</td>
                <td style="padding: 12px 8px; color: rgba(255,255,255,0.8);">
                  <a href="https://www.strava.com/activities/${a.id}" target="_blank" style="color: #22d3ee; text-decoration: none;">
                    ${a.name || 'Sans nom'}
                  </a>
                </td>
                <td style="padding: 12px 8px; text-align: right; font-family: 'Space Mono', monospace;">${(a.distance / 1000).toFixed(2)} km</td>
                <td style="padding: 12px 8px; text-align: right; font-family: 'Space Mono', monospace;">+${Math.round(a.total_elevation_gain)} m</td>
                <td style="padding: 12px 8px; text-align: center;">
                  ${a.excluded 
                    ? '<span style="color: #ef4444; font-size: 12px;">‚ùå Exclue</span>' 
                    : '<span style="color: #10b981; font-size: 12px;">‚úÖ Active</span>'}
                </td>
                <td style="padding: 12px 8px; text-align: center;">
                  <button onclick="toggleActivityExclusion(${a.id}, ${!a.excluded})" style="padding: 6px 12px; background: ${a.excluded ? '#10b981' : '#ef4444'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    ${a.excluded ? '‚Ü©Ô∏è R√©int√©grer' : 'üö´ Exclure'}
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        ${filtered.length > 100 ? `<p style="color: rgba(255,255,255,0.5); padding: 12px; text-align: center;">Affichage limit√© √† 100 activit√©s sur ${filtered.length}</p>` : ''}
      `;
    }

    async function toggleActivityExclusion(activityId, exclude) {
      try {
        const response = await fetch(`${API_BASE}/admin/activities/${LEAGUE_ID}/${activityId}/exclude`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Admin-Password': adminPassword 
          },
          body: JSON.stringify({ exclude })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la modification');
        }

        const data = await response.json();
        
        // Mettre √† jour localement
        const activity = allActivities.find(a => a.id === activityId);
        if (activity) {
          activity.excluded = exclude;
          activity.excluded_at = exclude ? new Date().toISOString() : null;
          activity.excluded_reason = exclude ? 'Exclu par admin' : null;
        }

        renderActivitiesList();
        
        // Mettre √† jour le compteur
        const excludedCount = allActivities.filter(a => a.excluded).length;
        document.getElementById('statExcluded').textContent = excludedCount;

        addLog(`${exclude ? 'üö´' : '‚Ü©Ô∏è'} Activit√© ${activityId}: ${exclude ? 'exclue' : 'r√©int√©gr√©e'}`);

      } catch (error) {
        addLog(`‚ùå Erreur: ${error.message}`);
        alert('Erreur: ' + error.message);
      }
    }

    // Event listeners pour les filtres
    document.getElementById('activitySearch').addEventListener('input', renderActivitiesList);
    document.getElementById('activityFilter').addEventListener('change', renderActivitiesList);
    document.getElementById('refreshActivitiesBtn').addEventListener('click', loadDashboardData);

    // ============================================
    // WEBHOOK STRAVA
    // ============================================
    document.getElementById('enableWebhookBtn').addEventListener('click', async () => {
      const btn = document.getElementById('enableWebhookBtn');
      const status = document.getElementById('webhookStatus');
      
      btn.disabled = true;
      btn.textContent = 'Activation...';
      
      try {
        const response = await fetch(`${API_BASE}/admin/strava/subscribe`, {
          method: 'POST',
          headers: { 'X-Admin-Password': adminPassword }
        });

        const data = await response.json();

        if (response.ok) {
          status.innerHTML = `Statut: <span style="color: #10b981;">‚úÖ Actif</span> (ID: ${data.subscription?.id || 'existant'})`;
          addLog(`‚úÖ Webhook Strava: ${data.message}`);
        } else {
          status.innerHTML = `Statut: <span style="color: #ef4444;">‚ùå ${data.error}</span>`;
          addLog(`‚ùå Webhook erreur: ${JSON.stringify(data.details || data.error)}`);
        }
      } catch (error) {
        status.innerHTML = `Statut: <span style="color: #ef4444;">‚ùå Erreur r√©seau</span>`;
        addLog(`‚ùå Erreur: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = '‚úÖ Activer';
      }
    });

    document.getElementById('disableWebhookBtn').addEventListener('click', async () => {
      if (!confirm('D√©sactiver le webhook ? Vous ne recevrez plus les activit√©s en temps r√©el.')) return;

      const btn = document.getElementById('disableWebhookBtn');
      const status = document.getElementById('webhookStatus');
      
      btn.disabled = true;
      
      try {
        const response = await fetch(`${API_BASE}/admin/strava/subscribe`, {
          method: 'DELETE',
          headers: { 'X-Admin-Password': adminPassword }
        });

        const data = await response.json();
        status.innerHTML = `Statut: <span style="color: #fbbf24;">‚ö†Ô∏è D√©sactiv√©</span>`;
        addLog(`üóëÔ∏è Webhook d√©sactiv√©`);
      } catch (error) {
        addLog(`‚ùå Erreur: ${error.message}`);
      } finally {
        btn.disabled = false;
      }
    });

    // ============================================
    // SYNCHRONISATION
    // ============================================
    document.getElementById('syncBtn').addEventListener('click', async () => {
      const btn = document.getElementById('syncBtn');
      const result = document.getElementById('syncResult');
      const startDate = document.getElementById('syncStartDate').value;
      const endDate = document.getElementById('syncEndDate').value;

      btn.disabled = true;
      btn.textContent = 'Synchronisation...';
      result.innerHTML = '<span style="color: #fbbf24;">‚è≥ En cours...</span>';

      try {
        const response = await fetch(`${API_BASE}/sync/${LEAGUE_ID}`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Admin-Password': adminPassword
          },
          body: JSON.stringify({ startDate, endDate })
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        result.innerHTML = `<span style="color: #10b981;">‚úÖ ${data.totalActivities} activit√©s synchronis√©es</span>`;
        addLog(`‚úÖ Sync: ${data.totalActivities} activit√©s pour ${data.athletesCount} athl√®tes`);
        
        loadDashboardData();

      } catch (error) {
        result.innerHTML = `<span style="color: #ef4444;">‚ùå ${error.message}</span>`;
        addLog(`‚ùå Sync erreur: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Lancer la synchronisation';
      }
    });

    // ============================================
    // EXPORT CLASSEMENT
    // ============================================
    document.getElementById('exportRankingBtn').addEventListener('click', async () => {
      const btn = document.getElementById('exportRankingBtn');
      btn.disabled = true;
      btn.textContent = 'G√©n√©ration...';

      try {
        const response = await fetch(`${API_BASE}/admin/ranking/${LEAGUE_ID}/export`, {
          headers: { 'X-Admin-Password': adminPassword }
        });

        if (!response.ok) throw new Error('Erreur export');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `classement-${LEAGUE_ID}-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        window.URL.revokeObjectURL(url);

        addLog(`üì• Classement export√©`);

      } catch (error) {
        addLog(`‚ùå Erreur export: ${error.message}`);
        alert('Erreur: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì• T√©l√©charger le classement (JSON)';
      }
    });

    // ============================================
    // T√âL√âCHARGEMENTS
    // ============================================
    document.querySelectorAll('.download-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const fileType = btn.dataset.file;
        
        try {
          let url, filename;

          if (fileType === 'athletes') {
            url = `${API_BASE}/admin/athletes/download`;
            filename = 'athletes.json';
          } else if (fileType === 'activities') {
            url = `${API_BASE}/admin/activities/${LEAGUE_ID}/download`;
            filename = `${LEAGUE_ID}_activities.json`;
          } else if (fileType === 'jokers') {
            url = `${API_BASE}/admin/jokers/download`;
            filename = 'jokers_usage.json';
          }

          const response = await fetch(url, {
            headers: { 'X-Admin-Password': adminPassword }
          });

          if (!response.ok) throw new Error('Erreur t√©l√©chargement');

          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = filename;
          a.click();
          window.URL.revokeObjectURL(downloadUrl);

          addLog(`üì• ${filename} t√©l√©charg√©`);

        } catch (error) {
          addLog(`‚ùå Erreur: ${error.message}`);
        }
      });
    });

    // ============================================
    // LOGS
    // ============================================
    function addLog(message) {
      const container = document.getElementById('logsContainer');
      const time = new Date().toLocaleTimeString('fr-FR');
      const logEntry = document.createElement('div');
      logEntry.style.marginBottom = '8px';
      logEntry.innerHTML = `<span style="color: rgba(255,255,255,0.4);">[${time}]</span> ${message}`;
      
      if (container.children.length === 1 && container.children[0].textContent.includes('En attente')) {
        container.innerHTML = '';
      }
      
      container.insertBefore(logEntry, container.firstChild);
    }

    // ============================================
    // GESTION DES JOKERS
    // ============================================
    let jokersData = {};

    async function loadJokersData() {
      const container = document.getElementById('jokersManagement');
      try {
        const response = await fetch(`${API_BASE}/admin/jokers/${LEAGUE_ID}`, {
          headers: { 'X-Admin-Password': adminPassword }
        });
        
        if (!response.ok) throw new Error('Erreur chargement jokers');
        
        jokersData = await response.json();
        renderJokersManagement();
        addLog('üÉè Donn√©es jokers charg√©es');
      } catch (error) {
        container.innerHTML = `<p style="color: #ef4444;">‚ùå ${error.message}</p>`;
        addLog(`‚ùå Erreur jokers: ${error.message}`);
      }
    }

    function renderJokersManagement() {
      const container = document.getElementById('jokersManagement');
      const { athletes, usage } = jokersData;
      
      if (!athletes || athletes.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.5);">Aucun athl√®te trouv√©</p>';
        return;
      }

      const jokerTypes = [
        { id: 'duel', icon: '‚öîÔ∏è', label: 'Duel' },
        { id: 'multiplicateur', icon: '‚úñÔ∏è', label: '√ó2' },
        { id: 'bouclier', icon: 'üõ°Ô∏è', label: 'Bouclier' },
        { id: 'sabotage', icon: 'üí£', label: 'Sabotage' }
      ];

      let html = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
              <th style="text-align: left; padding: 12px; color: rgba(255,255,255,0.6);">Athl√®te</th>
              ${jokerTypes.map(j => `<th style="text-align: center; padding: 12px; color: rgba(255,255,255,0.6);">${j.icon}</th>`).join('')}
              <th style="text-align: center; padding: 12px; color: rgba(255,255,255,0.6);">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      athletes.forEach(athlete => {
        const stock = athlete.jokerStock || { duel: 2, multiplicateur: 2, bouclier: 2, sabotage: 2 };
        const athleteUsage = (usage || []).filter(u => u.athleteId === athlete.id);
        
        html += `
          <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);" data-athlete-id="${athlete.id}">
            <td style="padding: 12px;">
              <div style="font-weight: 600;">${athlete.firstname} ${athlete.lastname}</div>
              <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">ID: ${athlete.id}</div>
            </td>
            ${jokerTypes.map(j => `
              <td style="text-align: center; padding: 12px;">
                <input type="number" 
                       class="joker-input" 
                       data-type="${j.id}"
                       value="${stock[j.id] || 0}" 
                       min="0" max="5"
                       style="width: 50px; padding: 6px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white; text-align: center; font-family: 'Space Mono', monospace;">
              </td>
            `).join('')}
            <td style="text-align: center; padding: 12px;">
              <button onclick="saveAthleteJokers('${athlete.id}')" 
                      style="padding: 6px 12px; background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.3); border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                üíæ Sauver
              </button>
            </td>
          </tr>
        `;

        // Afficher les jokers utilis√©s
        if (athleteUsage.length > 0) {
          html += `
            <tr style="background: rgba(0,0,0,0.2);">
              <td colspan="6" style="padding: 8px 12px 12px 24px;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 6px;">Historique d'utilisation :</div>
                ${athleteUsage.map(u => `
                  <div style="display: inline-block; padding: 4px 8px; margin: 2px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 0.75rem;">
                    ${getJokerIcon(u.type)} ${u.type}
                    ${u.targetId ? ` ‚Üí ${getJokerTargetName(u.targetId)}` : ''}
                    <span style="color: rgba(255,255,255,0.3);">R${u.round}</span>
                    <span style="color: ${u.resolved ? '#10b981' : '#f97316'};">${u.resolved ? '‚úì' : '‚è≥'}</span>
                  </div>
                `).join('')}
              </td>
            </tr>
          `;
        }
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function getJokerIcon(type) {
      const icons = { duel: '‚öîÔ∏è', multiplicateur: '‚úñÔ∏è', bouclier: 'üõ°Ô∏è', sabotage: 'üí£' };
      return icons[type] || 'üÉè';
    }

    function getJokerTargetName(id) {
      if (athletesCache[id]) {
        const a = athletesCache[id];
        if (a.firstname && a.lastname) {
          return `${a.firstname} ${a.lastname.charAt(0)}.`;
        }
        return a.name || `#${id}`;
      }
      return `#${id}`;
    }

    async function saveAthleteJokers(athleteId) {
      const row = document.querySelector(`tr[data-athlete-id="${athleteId}"]`);
      const inputs = row.querySelectorAll('.joker-input');
      
      const jokerStock = {};
      inputs.forEach(input => {
        jokerStock[input.dataset.type] = parseInt(input.value) || 0;
      });

      try {
        const response = await fetch(`${API_BASE}/admin/jokers/${athleteId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Password': adminPassword
          },
          body: JSON.stringify({ jokerStock })
        });

        if (!response.ok) throw new Error('Erreur sauvegarde');

        addLog(`‚úÖ Jokers mis √† jour pour athl√®te ${athleteId}`);
        
        // Flash vert pour confirmer
        row.style.background = 'rgba(16,185,129,0.1)';
        setTimeout(() => { row.style.background = ''; }, 1000);

      } catch (error) {
        addLog(`‚ùå Erreur: ${error.message}`);
        alert('Erreur: ' + error.message);
      }
    }

    async function resetAllJokers() {
      if (!confirm('‚ö†Ô∏è R√©initialiser TOUS les jokers √† leur valeur initiale (2 de chaque) ?\n\nCette action est irr√©versible.')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/jokers/reset/${LEAGUE_ID}`, {
          method: 'POST',
          headers: { 'X-Admin-Password': adminPassword }
        });

        if (!response.ok) throw new Error('Erreur reset');

        const data = await response.json();
        addLog(`üîÑ ${data.count} athl√®tes r√©initialis√©s`);
        loadJokersData();

      } catch (error) {
        addLog(`‚ùå Erreur reset: ${error.message}`);
        alert('Erreur: ' + error.message);
      }
    }

    // Event listeners jokers
    document.getElementById('refreshJokersBtn')?.addEventListener('click', loadJokersData);
    document.getElementById('resetJokersBtn')?.addEventListener('click', resetAllJokers);

    // ============================================
    // INIT
    // ============================================
    checkAuth();
  </script>
</body>
</html>
